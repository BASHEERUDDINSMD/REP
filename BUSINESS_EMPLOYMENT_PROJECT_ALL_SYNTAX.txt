CREATE OR REPLACE DATABASE DB_BUSINESS_EMPLOYMENT_STG;

CREATE OR REPLACE SCHEMA DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT;

CREATE OR REPLACE DATABASE DB_BUSINESS_EMPLOYMENT;

CREATE OR REPLACE SCHEMA DB_BUSINESS_EMPLOYMENT.SCH_BUSINESS_EMPLOYMENT;

CREATE OR REPLACE TABLE DB_BUSINESS_EMPLOYMENT.SCH_BUSINESS_EMPLOYMENT.BUSINESS_EMPLOYMENT_INTSTAGE
(
PERIOD VARCHAR,
SERIES_REFERENCE VARCHAR,
REGION_NAME VARCHAR,
FILLED_JOBS INT,
FILLED_JOBS_REVISED INT,
FILLED_JOBS_DIFF INT,
FILLED_JOBS_PERCE_DIFF FLOAT,
TOTAL_EARNINGS INT,
TOTAL_EARNINGS_REVISED INT,
EARNINGS_DIFF INT,
EARNINGS_PERC_DIFF FLOAT
);

CREATE OR REPLACE FILE FORMAT DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.CSV_FILEFORMAT
TYPE = CSV
TRIM_SPACE = TRUE
COMPRESSION = AUTO
FIELD_DELIMITER = ','
RECORD_DELIMITER = '\n'
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
NULL_IF = ('\N')
SKIP_HEADER = 1 
ESCAPE = 'NONE' 
ERROR_ON_COLUMN_COUNT_MISMATCH = TRUE;

CREATE OR REPLACE STAGE DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.STG_BUSINESS_EMPLOYMENT
URL = 's3://project-s3-bucket-basheer/'
STORAGE_INTEGRATION = AWS_TOVID_INTEGRATION;

LIST @DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.STG_BUSINESS_EMPLOYMENT;

CREATE OR REPLACE PIPE DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.PIPE_BUSINESS_EMPLOYMENT
AUTO_INGEST = TRUE 
AS 
COPY INTO DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.BUSINESS_EMPLOYMENT 
FROM @DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.STG_BUSINESS_EMPLOYMENT 
FILE_FORMAT = (FORMAT_NAME = 'DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.CSV_FILEFORMAT')
ON_ERROR = 'SKIP_FILE';

SHOW PIPES;

SELECT * FROM TABLE(INFORMATION_SCHEMA.COPY_HISTORY(TABLE_NAME => 'DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.BUSINESS_EMPLOYMENT', START_TIME => DATEADD(HOUR, -1,CURRENT_TIMESTAMP())));

CREATE OR REPLACE STREAM DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.STRM_BUSINESS_EMPLOYMENT 
ON TABLE DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.BUSINESS_EMPLOYMENT 
APPEND_ONLY = TRUE;

SELECT SYSTEM$STREAM_HAS_DATA('DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.STRM_BUSINESS_EMPLOYMENT');

CREATE OR REPLACE PROCEDURE DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.PROC_BUSINESS_EMPLOYMENT()
RETURNS STRING NOT NULL
LANGUAGE javascript
AS 
$$
var stream_select_cmd = `
INSERT INTO DB_BUSINESS_EMPLOYMENT.SCH_BUSINESS_EMPLOYMENT.BUSINESS_EMPLOYMENT_SNOWPIPE 
SELECT 
PERIOD :: VARCHAR,
SERIES_REFERENCE :: VARCHAR,
REGION_NAME :: VARCHAR,
FILLED_JOBS :: INT,
FILLED_JOBS_REVISED :: INT,
FILLED_JOBS_DIFF :: INT,
FILLED_JOBS_PERCE_DIFF :: FLOAT,
TOTAL_EARNINGS :: INT,
TOTAL_EARNINGS_REVISED :: INT,
EARNINGS_DIFF :: INT,
EARNINGS_PERC_DIFF :: FLOAT
FROM 
DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.STRM_BUSINESS_EMPLOYMENT
WHERE 
METADATA$ACTION = 'INSERT';
`
var sql_select_stream = snowflake.createStatement({sqlText:stream_select_cmd});
var stream_select_results = sql_select_stream.execute();
return 'DONE';
$$;


CREATE OR REPLACE TASK DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.TSK_BUSINESS_EMPLOYMENT
SCHEDULE = '1 MINUTE'
WAREHOUSE = 'PROJECT1_WH'
WHEN
SYSTEM$STREAM_HAS_DATA('DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.STRM_BUSINESS_EMPLOYMENT')
AS
CALL DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.PROC_BUSINESS_EMPLOYMENT();

SHOW TASKS;

ALTER TASK DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.TSK_BUSINESS_EMPLOYMENT RESUME;
ALTER TASK DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.TSK_BUSINESS_EMPLOYMENT SUSPEND;

SELECT * FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY(SCHEDULED_TIME_RANGE_START => DATEADD(HOUR,-1,CURRENT_TIMESTAMP()), TASK_NAME => 'TSK_BUSINESS_EMPLOYMENT'));

SELECT * FROM DB_BUSINESS_EMPLOYMENT.SCH_BUSINESS_EMPLOYMENT.BUSINESS_EMPLOYMENT_SNOWPIPE;

COPY INTO DB_BUSINESS_EMPLOYMENT.SCH_BUSINESS_EMPLOYMENT.BUSINESS_EMPLOYMENT_EXTLOC 
FROM s3://project-s3-bucket-basheer/business1.csv 
STORAGE_INTEGRATION = AWS_TOVID_INTEGRATION
FILE_FORMAT = (FORMAT_NAME = 'DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.CSV_FILEFORMAT')
ON_ERROR = 'ABORT_STATEMENT'
PURGE = TRUE;

SELECT * FROM DB_BUSINESS_EMPLOYMENT.SCH_BUSINESS_EMPLOYMENT.BUSINESS_EMPLOYMENT_EXTLOC;

LIST @DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.STG_BUSINESS_EMPLOYMENT;

COPY INTO DB_BUSINESS_EMPLOYMENT.SCH_BUSINESS_EMPLOYMENT.BUSINESS_EMPLOYMENT_BATCHLOAD 
FROM @DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.STG_BUSINESS_EMPLOYMENT
FILE_FORMAT = (FORMAT_NAME = 'DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.CSV_FILEFORMAT')
ON_ERROR = 'ABORT_STATEMENT'
PURGE = TRUE;

SELECT * FROM DB_BUSINESS_EMPLOYMENT.SCH_BUSINESS_EMPLOYMENT.BUSINESS_EMPLOYMENT_BATCHLOAD;

SELECT * FROM DB_BUSINESS_EMPLOYMENT.SCH_BUSINESS_EMPLOYMENT.BUSINESS_EMPLOYMENT_WEBUI;

PUT FILE://"C:\Users\BASHEERUDDIN\Downloads\business2.csv" @%DB_BUSINESS_EMPLOYMENT.SCH_BUSINESS_EMPLOYMENT.BUSINESS_EMPLOYMENT_INTSTAGE;

COPY INTO DB_BUSINESS_EMPLOYMENT.SCH_BUSINESS_EMPLOYMENT.BUSINESS_EMPLOYMENT_INTSTAGE 
FROM @%DB_BUSINESS_EMPLOYMENT.SCH_BUSINESS_EMPLOYMENT.BUSINESS_EMPLOYMENT_INTSTAGE
FILE_FORMAT = (FORMAT_NAME = 'DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.CSV_FILEFORMAT');

TRUNCATE TABLE DB_BUSINESS_EMPLOYMENT_STG.SCH_BUSINESS_EMPLOYMENT.BUSINESS_EMPLOYMENT;

TRUNCATE TABLE DB_ASTRA_GENECA_STG.SCH_ASTRA_GENECA.EPIDEMIOLOGICAL_DATA;